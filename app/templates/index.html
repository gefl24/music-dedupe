<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐管家 & AI 去重</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .col-checkbox { width: 40px; }
        .col-action { width: 90px; text-align: center; }
        .col-file { width: 200px; } 
        
        .log-box { font-family: 'Courier New', Courier, monospace; font-size: 12px; line-height: 1.4; }
        
        .toast {
            position: fixed; top: 80px; right: 20px; z-index: 9999;
            min-width: 300px; max-width: 500px; padding: 12px 16px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        
        tr.selected { background: #fef3c7 !important; border-left: 3px solid #f59e0b; }
        .progress-bar { transition: width 0.3s ease-out; }
        
        .tooltip { position: relative; }
        .tooltip:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); padding: 4px 8px; background: #1f2937;
            color: white; font-size: 11px; white-space: nowrap;
            border-radius: 4px; margin-bottom: 4px; z-index: 100;
        }
        
        .task-layout { display: flex; gap: 1rem; height: 100%; overflow: hidden; }
        .task-left { width: 33.3333%; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; min-width: 320px; padding-right: 4px; }
        .task-right { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">
    <div id="app" class="h-full flex flex-col">
        <transition name="fade">
            <div v-if="toast.show" :class="['toast', `toast-${toast.type}`]" class="fade-in">
                <div class="flex items-center gap-2">
                    <i :class="toastIcon"></i>
                    <span>{{ toast.message }}</span>
                </div>
            </div>
        </transition>

        <header class="bg-white shadow z-10 shrink-0">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <i class="fa-solid fa-music"></i> 音乐管家
                </h1>
                
                <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                    <button @click="switchTab('manager')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'manager', 'text-gray-500 hover:text-gray-700': currentTab !== 'manager'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-folder-open"></i> 文件管理
                    </button>
                    <button @click="switchTab('tasks')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'tasks', 'text-gray-500 hover:text-gray-700': currentTab !== 'tasks'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-clock"></i> 计划任务
                    </button>
                    <button @click="switchTab('dedupe')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'dedupe', 'text-gray-500 hover:text-gray-700': currentTab !== 'dedupe'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-clone"></i> AI 去重
                    </button>
                </div>

                <div class="text-sm flex items-center gap-3">
                    <div v-if="isBusy && !isSilentPolling" class="flex items-center gap-2 text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                        <i class="fa-solid fa-circle-notch loading-spin"></i> 处理中...
                    </div>
                    <span v-if="config.has_key" class="text-green-600 font-bold flex items-center gap-1 tooltip" data-tip="API 已配置">
                        <i class="fa-solid fa-check-circle"></i> {{ config.model_name }}
                    </span>
                    <span v-else class="text-red-500 flex items-center gap-1 tooltip" data-tip="请前往配置页设置 API Key">
                        <i class="fa-solid fa-exclamation-triangle"></i> 未配置 API
                    </span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden container mx-auto p-4 sm:p-6 relative">
            
            <div v-show="currentTab === 'manager'" class="h-full flex gap-4">
                <div class="w-72 bg-white rounded-lg shadow-sm flex flex-col overflow-hidden shrink-0 border border-gray-200">
                    <div class="p-3 border-b bg-gray-50 font-bold text-gray-700 text-sm flex justify-between items-center">
                        <span class="truncate pr-2 text-xs font-mono" :title="currentNavPath || '根目录'">
                            <i class="fa-solid fa-folder-tree mr-1 text-indigo-500"></i> {{ currentNavPathName }}
                        </span>
                        <div class="flex gap-1">
                            <button v-if="!isNavRoot" @click="fetchDirs(parentNavPath)" class="text-gray-500 hover:text-indigo-600 p-1 rounded hover:bg-gray-200 tooltip" data-tip="返回上级">
                                <i class="fa-solid fa-level-up-alt"></i>
                            </button>
                            <button @click="fetchDirs(currentNavPath)" class="text-gray-500 hover:text-indigo-600 p-1 rounded hover:bg-gray-200 tooltip" data-tip="刷新目录">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-2 text-sm">
                        <div @click="selectFolder('')" class="cursor-pointer px-3 py-2 rounded mb-1 flex justify-between items-center hover:bg-gray-100 transition border border-transparent"
                            :class="{'bg-indigo-50 text-indigo-700 font-bold border-indigo-100': currentFolder === ''}">
                            <span><i class="fa-solid fa-music mr-2 text-gray-400"></i> 全部已加载</span>
                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">{{ allFiles.length }}</span>
                        </div>
                        
                        <hr class="my-2 border-gray-100">

                        <div v-if="loadingDirs" class="space-y-2 p-2">
                            <div v-for="i in 3" :key="i" class="h-8 bg-gray-100 rounded animate-pulse"></div>
                        </div>
                        
                        <div v-else-if="subDirs.length === 0" class="text-center text-gray-400 py-4 italic text-xs">
                            当前目录下无子文件夹
                        </div>
                        
                        <div v-else v-for="dir in subDirs" :key="dir.path"
                            class="group flex items-center justify-between px-3 py-2 rounded mb-1 hover:bg-gray-100 transition border border-transparent"
                            :class="{'bg-indigo-50 border-indigo-100': filterFolder === dir.path}">
                            
                            <div @click="fetchDirs(dir.path)" class="flex-1 cursor-pointer truncate mr-2 text-gray-700 hover:text-indigo-700 select-none" :title="dir.name">
                                <i class="fa-regular fa-folder mr-2 text-yellow-500 group-hover:text-yellow-600"></i> {{ dir.name }}
                            </div>
                            
                            <button @click.stop="scanFolder(dir.path)" :disabled="isBusy" class="text-gray-300 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition-colors tooltip" data-tip="扫描此文件夹并加载">
                                <i class="fa-solid fa-magnifying-glass" :class="{'text-blue-500 loading-spin': isScanningPath === dir.path}"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded-lg shadow-sm flex flex-col overflow-hidden min-w-0 border border-gray-200">
                    <div class="p-3 border-b flex gap-2 items-center flex-wrap bg-gray-50">
                        <div class="relative flex-1 min-w-[200px]">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                            <input type="text" v-model="fileSearch" placeholder="搜索文件名、标题、艺术家..." 
                                class="w-full border border-gray-300 p-1.5 pl-8 rounded text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">每页:</span>
                            <select v-model.number="pageSize" @change="currentPage = 1" class="border border-gray-300 p-1.5 rounded text-sm w-20 bg-white focus:outline-none">
                                <option :value="50">50</option>
                                <option :value="100">100</option>
                                <option :value="300">300</option>
                                <option :value="500">500</option>
                                <option :value="1000">1000</option>
                            </select>
                        </div>
                        
                        <button @click="refreshFiles" :disabled="loadingFiles" class="bg-white border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-50 text-gray-600 transition disabled:opacity-50 tooltip" data-tip="刷新列表">
                            <i class="fa-solid fa-sync" :class="{'loading-spin': loadingFiles}"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <table class="w-full text-sm text-left table-fixed border-collapse">
                            <thead class="bg-gray-50 sticky top-0 shadow-sm z-10 text-gray-600 text-xs uppercase tracking-wider font-semibold">
                                <tr>
                                    <th class="p-2 col-checkbox border-b border-gray-200 text-center">
                                        <input type="checkbox" @change="toggleSelectAllFiles" :checked="isAllFilesSelected" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </th>
                                    <th class="p-2 col-action border-b border-gray-200">操作</th>
                                    <th class="p-2 col-file border-b border-gray-200">文件名</th>
                                    <th class="p-2 border-b border-gray-200">标题</th>
                                    <th class="p-2 border-b border-gray-200">艺术家</th>
                                    <th class="p-2 border-b border-gray-200">专辑</th>
                                    <th class="p-2 border-b border-gray-200">专辑艺术家</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white">
                                <tr v-if="loadingFiles" v-for="i in pageSize" :key="'skeleton-'+i">
                                    <td colspan="7" class="p-2"><div class="h-8 bg-gray-100 rounded animate-pulse"></div></td>
                                </tr>
                                
                                <tr v-else v-for="file in paginatedFiles" :key="file.path" class="group hover:bg-blue-50 transition-colors" :class="{'selected': isFileSelected(file.path)}">
                                    <td class="p-2 text-center">
                                        <input type="checkbox" :value="file.path" v-model="managerSelection" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </td>
                                    <td class="p-2 flex justify-center gap-2">
                                        <button @click="fixSingleAI(file)" :disabled="loadingAiFiles[file.path]" 
                                            class="w-7 h-7 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-500 hover:bg-indigo-600 hover:text-white transition disabled:opacity-30 tooltip" data-tip="AI 智能识别并修复元数据">
                                            <i class="fa-solid fa-wand-magic-sparkles" :class="{'loading-spin': loadingAiFiles[file.path]}"></i>
                                        </button>
                                        <button @click="deleteOne(file)" class="w-7 h-7 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-600 hover:text-white transition tooltip" data-tip="删除文件">
                                            <i class="fa-solid fa-trash-alt"></i>
                                        </button>
                                    </td>
                                    <td class="p-2 truncate font-medium text-gray-700" :title="file.filename">{{ file.filename }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.title">{{ file.title }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.artist">{{ file.artist }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.album">{{ file.album }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.album_artist">{{ file.album_artist }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="p-2 bg-gray-50 text-xs text-gray-500 border-t flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3">
                            <span>显示 {{ paginatedFiles.length }} / {{ filteredFiles.length }} (总 {{ allFiles.length }})</span>
                            <span v-if="managerSelection.length > 0" class="text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded">已选 {{ managerSelection.length }}</span>
                        </div>
                        
                        <div class="flex gap-2 items-center" v-if="totalPages > 1">
                            <button @click="currentPage--" :disabled="currentPage === 1" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-100 disabled:opacity-50">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span class="min-w-[3rem] text-center font-mono">{{ currentPage }} / {{ totalPages }}</span>
                            <button @click="currentPage++" :disabled="currentPage === totalPages" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-100 disabled:opacity-50">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="w-72 flex flex-col gap-4 overflow-y-auto shrink-0 pb-4">
                    <div v-if="managerSelection.length > 0" class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm slide-in">
                        <h3 class="font-bold text-red-700 mb-2 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-triangle-exclamation"></i> 危险操作
                        </h3>
                        <button @click="deleteManagerSelection" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 text-sm shadow transition font-bold">
                            <i class="fa-solid fa-trash-can mr-1"></i> 删除选中 ({{ managerSelection.length }})
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm pb-2 border-b">
                            <i class="fa-solid fa-tags text-indigo-500"></i> 批量修改标签
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">艺术家 (Artist)</label>
                                <input type="text" v-model="metaEdit.artist" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-xs focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">标题 (Title)</label>
                                <input type="text" v-model="metaEdit.title" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-xs focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">专辑 (Album)</label>
                                <input type="text" v-model="metaEdit.album" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-xs focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">专辑艺术家 (Album Artist)</label>
                                <input type="text" v-model="metaEdit.album_artist" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-xs focus:border-indigo-500 focus:outline-none">
                            </div>
                            
                            <button @click="applyMetadata" :disabled="managerSelection.length === 0" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50 text-sm mt-1">
                                应用修改 ({{ managerSelection.length }})
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm pb-2 border-b">
                            <i class="fa-solid fa-i-cursor text-blue-500"></i> 批量重命名
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">命名模式 (Pattern)</label>
                                <input type="text" v-model="renamePattern" class="w-full border p-2 rounded text-xs font-mono bg-gray-50">
                            </div>
                            <div class="flex gap-1.5 flex-wrap">
                                <button @click="renamePattern += '{artist}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] border">{artist}</button>
                                <button @click="renamePattern += '{title}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] border">{title}</button>
                                <button @click="renamePattern += '{album}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] border">{album}</button>
                            </div>
                            <div class="text-xs text-gray-500 bg-blue-50 p-2 rounded border border-blue-100 break-all">
                                <span class="font-bold text-blue-800">预览:</span> {{ previewRename }}.mp3
                            </div>
                            <button @click="applyRename" :disabled="managerSelection.length === 0" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50 text-sm">
                                开始重命名 ({{ managerSelection.length }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'tasks'" class="task-layout">
                <div class="task-left">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 shadow-sm shrink-0">
                        <h2 class="font-bold text-indigo-800 mb-2 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-crosshairs"></i> 任务作用域
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" v-model="taskTargetFolder" class="flex-1 border border-indigo-200 p-2 rounded text-xs bg-white font-mono" readonly>
                            <button @click="showFolderSelector = !showFolderSelector" class="bg-indigo-600 text-white px-2 rounded text-xs hover:bg-indigo-700">选择</button>
                        </div>
                        <div v-if="showFolderSelector" class="mt-2 bg-white border rounded shadow-lg max-h-48 overflow-y-auto">
                            <div @click="selectTaskFolder(config.music_dir)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-xs font-bold border-b">/ (根目录)</div>
                            <div v-for="dir in folderSelectorList" :key="dir.path" @click="selectTaskFolder(dir.path)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-xs text-gray-700 border-b border-gray-50">
                                <i class="fa-regular fa-folder mr-2 text-yellow-500"></i> {{ dir.name }}
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <div v-for="(task, key) in taskConfig" :key="key" class="bg-white rounded-lg shadow-sm p-3 border border-gray-200 hover:border-indigo-300 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-gray-800 text-sm">{{ getTaskName(key) }}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs text-gray-400 font-mono">Cron:</span>
                                        <input type="text" v-model="task.cron" class="border-b border-gray-300 text-xs text-gray-600 focus:outline-none focus:border-indigo-500 w-24 font-mono">
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="task.enabled" class="sr-only peer">
                                    <div class="w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                            </div>
                            
                            <div v-if="key === 'clean_short'" class="mb-2">
                                <label class="text-xs text-gray-500">最小时长(s):</label>
                                <input type="number" v-model.number="task.min_duration" class="border rounded px-1 w-12 text-xs ml-2">
                            </div>
                            
                            <div class="flex justify-between items-center mt-2 border-t pt-2">
                                <span class="text-[10px] text-gray-400 truncate max-w-[100px]" :title="task.last_run">上次: {{ task.last_run || '无' }}</span>
                                <button @click="runTask(key)" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100">
                                    <i class="fa-solid fa-play mr-1"></i> 执行
                                </button>
                            </div>
                        </div>
                        
                        <button @click="saveTasksConfig" class="bg-indigo-600 text-white w-full py-2 rounded shadow hover:bg-indigo-700 transition text-sm font-bold mt-2">
                            <i class="fa-solid fa-save mr-1"></i> 保存计划设置
                        </button>
                    </div>
                </div>

                <div class="task-right">
                    <div class="bg-gray-900 rounded-lg shadow-lg flex flex-col overflow-hidden h-full text-gray-300 border border-gray-800">
                        <div class="p-2 border-b border-gray-700 bg-gray-800 text-xs font-bold flex justify-between items-center shrink-0">
                            <span><i class="fa-solid fa-terminal mr-2 text-green-500"></i> 系统实时日志</span>
                            <button @click="fetchLogs(false)" class="hover:text-white"><i class="fa-solid fa-sync"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 log-box bg-[#0d1117] text-xs">
                            <div v-for="(log, i) in taskLogs" :key="i" class="mb-1 border-b border-gray-800 pb-0.5">
                                <span class="text-green-600 mr-1">></span> {{ log }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'dedupe'" class="h-full overflow-y-auto pr-2 relative">
                
                <div v-if="isBusy && status.status !== 'idle'" class="overlay rounded-lg">
                    <div class="text-center">
                        <i class="fa-solid fa-circle-notch loading-spin text-4xl text-indigo-600 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">{{ status.status === 'scanning' ? '正在扫描去重目录...' : '正在进行 AI 分析...' }}</h3>
                        <p class="text-gray-500">{{ status.message }}</p>
                        <div class="w-64 bg-gray-200 rounded-full h-2 mt-4 mx-auto overflow-hidden">
                            <div class="progress-bar bg-indigo-600 h-2 rounded-full" :style="{ width: progressPercent + '%' }"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">{{ status.progress }} / {{ status.total }}</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-6">
                    <h2 class="font-bold text-gray-700 mb-2 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-folder-tree text-indigo-500"></i> 去重目标文件夹
                    </h2>
                    <div class="flex gap-2">
                        <input type="text" v-model="dedupeTargetPath" class="flex-1 border border-gray-300 p-2 rounded text-xs bg-gray-50 font-mono text-gray-600" readonly>
                        <button @click="showDedupeFolderSelector = !showDedupeFolderSelector" class="bg-white border border-gray-300 text-gray-600 px-3 rounded text-xs hover:bg-gray-50">更改...</button>
                    </div>
                    
                    <div v-if="showDedupeFolderSelector" class="mt-2 bg-white border rounded shadow-lg max-h-48 overflow-y-auto">
                        <div @click="selectDedupeFolder(config.music_dir)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-xs font-bold border-b text-indigo-600">/ (根目录)</div>
                        <div v-for="dir in folderSelectorList" :key="dir.path" @click="selectDedupeFolder(dir.path)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-xs text-gray-700 border-b border-gray-50 flex items-center">
                            <i class="fa-regular fa-folder mr-2 text-yellow-500"></i> {{ dir.name }}
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">注意：去重扫描将仅在此文件夹下进行，与文件管理列表无关。</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                        <h2 class="font-bold mb-4 text-gray-700 border-b pb-2">系统配置</h2>
                        <div class="space-y-4">
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">Gemini API Key</label>
                                <input type="password" v-model="form.apiKey" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500"></div>
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">Model Name</label>
                                <div class="flex gap-2">
                                    <input list="model-list" v-model="form.modelName" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500">
                                    <datalist id="model-list"><option v-for="m in availableModels" :value="m">{{ m }}</option></datalist>
                                    <button @click="fetchModels" class="bg-gray-100 border px-3 rounded hover:bg-gray-200"><i class="fa-solid fa-sync"></i></button>
                                </div>
                            </div>
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">HTTP Proxy</label>
                                <input type="text" v-model="form.proxyUrl" placeholder="http://127.0.0.1:7890" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500">
                            </div>
                            
                            <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 text-sm font-medium">保存配置</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h2 class="font-bold mb-4 text-gray-700 border-b pb-2">任务控制</h2>
                            <div class="bg-gray-50 p-4 rounded border border-gray-100 mb-4 min-h-[100px]">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span class="font-medium"><i class="fa-solid fa-info-circle text-blue-500"></i> {{ status.status }}</span>
                                    <span v-if="status.total > 0" class="bg-blue-100 text-blue-700 px-2 rounded text-xs">{{ status.progress }} / {{ status.total }}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3 h-10 overflow-hidden">{{ status.message }}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button @click="startScanAll" :disabled="isBusy" class="flex-1 border border-blue-500 text-blue-600 py-2 rounded hover:bg-blue-50 disabled:opacity-50">1. 扫描目标文件夹</button>
                            <button @click="startAnalyze" :disabled="isBusy || status.candidates_count === 0" class="flex-1 bg-purple-600 text-white py-2 rounded hover:bg-purple-700 disabled:opacity-50">
                                <i class="fa-solid fa-robot"></i> AI 分析
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="results.length > 0" class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-gray-800">
                            {{ isAiResult ? 'AI 分析结果' : '疑似重复 (模糊匹配)' }} 
                            <span class="ml-2 text-sm text-gray-500 font-normal">{{ status.results_count || status.candidates_count }} 组</span>
                        </h3>
                        <button v-if="selectedFiles.length > 0" @click="deleteSelected" class="bg-red-600 text-white px-5 py-2 rounded text-sm hover:bg-red-700 font-medium">
                            <i class="fa-solid fa-trash-can mr-1"></i> 删除选中 ({{ selectedFiles.length }})
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div v-for="(group, idx) in results" :key="idx" class="border rounded-lg p-4 bg-gray-50 hover:bg-white hover:shadow transition duration-200">
                            <div class="text-xs font-bold text-yellow-800 bg-yellow-100 p-2 rounded mb-3 inline-block">
                                <i class="fa-solid fa-lightbulb text-yellow-600 mr-1"></i> {{ group.reason || '标题高度相似' }}
                            </div>
                            
                            <div class="space-y-2">
                                <div v-for="file in group.files" :key="file.path" 
                                    @click="toggleSelect(file.path)"
                                    class="flex items-center gap-4 p-3 bg-white border border-gray-200 rounded-md cursor-pointer hover:border-indigo-500 transition-all duration-200"
                                    :class="{'ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50': isSelected(file.path)}">
                                    
                                    <div class="text-gray-300" :class="{'text-indigo-600': isSelected(file.path)}">
                                        <i class="fa-solid" :class="isSelected(file.path) ? 'fa-circle-check' : 'fa-circle'"></i>
                                    </div>

                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-sm text-gray-800 truncate">{{ file.filename }}</span>
                                            <span class="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded">{{ (file.size_mb).toFixed(1) }}MB</span>
                                            <span class="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded">{{ file.bitrate }}kbps</span>
                                        </div>
                                        <div class="text-xs text-gray-500 truncate" :title="file.path">{{ file.path }}</div>
                                    </div>
                                    
                                    <button class="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition">
                                        <i class="fa-solid fa-play"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                        <span class="text-xs text-gray-500">第 {{ dedupePage }} 页 / 共 {{ dedupeTotalPages }} 页</span>
                        <div class="flex gap-2">
                            <button @click="loadDedupePage(dedupePage - 1)" :disabled="dedupePage === 1" class="px-3 py-1 bg-white border rounded text-xs hover:bg-gray-50 disabled:opacity-50">上一页</button>
                            <button @click="loadDedupePage(dedupePage + 1)" :disabled="dedupePage === dedupeTotalPages" class="px-3 py-1 bg-white border rounded text-xs hover:bg-gray-50 disabled:opacity-50">下一页</button>
                        </div>
                    </div>
                </div>
                
                <div v-else class="text-center py-20 text-gray-400">
                    <i class="fa-solid fa-check-circle text-4xl mb-4 text-gray-200"></i>
                    <p>暂无重复文件结果</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // --- 状态 ---
                const currentTab = ref('manager');
                const isBusy = ref(false);
                const isSilentPolling = ref(false);
                const toast = ref({ show: false, message: '', type: 'info' });
                
                const config = ref({ has_key: false, model_name: '', music_dir: '/music' });
                const form = ref({ apiKey: '', modelName: 'gemini-1.5-flash', proxyUrl: '' });
                const availableModels = ref([]);
                const status = ref({ status: 'idle', progress: 0, total: 0, message: '', candidates_count: 0 });
                const initLoaded = ref(false);
                
                // File Manager
                const allFiles = ref([]);
                const subDirs = ref([]);
                const currentNavPath = ref('');
                const parentNavPath = ref('');
                const isNavRoot = ref(true);
                const isScanningPath = ref('');
                const fileSearch = ref('');
                const pageSize = ref(50);
                const currentPage = ref(1);
                const managerSelection = ref([]);
                const loadingFiles = ref(false);
                const loadingDirs = ref(false);
                const loadingAiFiles = ref({});
                
                // Metadata Edit & Rename
                const metaEdit = ref({ artist: '', title: '', album: '', album_artist: '' });
                const renamePattern = ref('{artist} - {title}');
                
                // Tasks
                const taskConfig = ref({});
                const taskTargetFolder = ref('');
                const showFolderSelector = ref(false);
                const taskLogs = ref([]);
                const folderSelectorList = ref([]);

                // Dedupe
                const dedupeTargetPath = ref('');
                const showDedupeFolderSelector = ref(false);
                const results = ref([]);
                const selectedFiles = ref([]);
                const isAiResult = ref(false);
                // ✅ 分页状态
                const dedupePage = ref(1);
                const dedupeTotalPages = ref(1);

                const taskNames = {
                    dedupe_quality: "音质去重 (自动保留最高音质)",
                    clean_short: "短音频清理 (删除过短片段)",
                    extract_meta: "元数据提取 (NFO & 封面)",
                    clean_junk: "垃圾清理 (空目录/冗余文件)"
                };
                const getTaskName = (key) => taskNames[key] || key;

                // --- 计算属性 ---
                const currentNavPathName = computed(() => currentNavPath.value || config.value.music_dir || 'Root');
                const toastIcon = computed(() => {
                    if (toast.value.type === 'success') return 'fa-solid fa-check-circle';
                    if (toast.value.type === 'error') return 'fa-solid fa-times-circle';
                    return 'fa-solid fa-info-circle';
                });
                const progressPercent = computed(() => {
                    if (!status.value.total) return 0;
                    return Math.min(100, (status.value.progress / status.value.total) * 100);
                });
                
                const filteredFiles = computed(() => {
                    let res = allFiles.value;
                    if (currentNavPath.value && currentNavPath.value !== config.value.music_dir) {
                        res = res.filter(f => f.path.startsWith(currentNavPath.value));
                    }
                    if (fileSearch.value) {
                        const q = fileSearch.value.toLowerCase();
                        res = res.filter(f => 
                            f.filename.toLowerCase().includes(q) || 
                            (f.artist && f.artist.toLowerCase().includes(q)) || 
                            (f.title && f.title.toLowerCase().includes(q))
                        );
                    }
                    return res;
                });
                
                const paginatedFiles = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    return filteredFiles.value.slice(start, start + pageSize.value);
                });
                
                const totalPages = computed(() => Math.ceil(filteredFiles.value.length / pageSize.value));
                const isAllFilesSelected = computed(() => paginatedFiles.value.length > 0 && paginatedFiles.value.every(f => isFileSelected(f.path)));
                
                const previewRename = computed(() => {
                    let n = renamePattern.value;
                    n = n.replace('{artist}', 'Adele').replace('{title}', 'Hello').replace('{album}', '25').replace('{album_artist}', 'Adele');
                    return n;
                });

                // --- 方法 ---
                const showToast = (msg, type = 'info') => {
                    toast.value = { show: true, message: msg, type };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if (tab === 'tasks') fetchLogs(false);
                    // 仅当没有结果且不忙时才尝试加载第一页
                    if (tab === 'dedupe' && results.value.length === 0 && !isBusy.value) loadDedupePage(1); 
                };

                const apiCall = async (url, method = 'GET', body = null) => {
                    try {
                        const opts = { method, headers: { 'Content-Type': 'application/json' } };
                        if (body) opts.body = JSON.stringify(body);
                        const res = await fetch(url, opts);
                        if (res.status === 401) {
                            window.location.reload();
                            return;
                        }
                        if (!res.ok) throw new Error(`API Error: ${res.status}`);
                        return await res.json();
                    } catch (e) {
                        if (!isSilentPolling.value) showToast(e.message, 'error');
                        throw e;
                    }
                };

                const fetchStatus = async (silent = false) => {
                    if (silent) isSilentPolling.value = true;
                    
                    try {
                        const data = await apiCall('/api/status');
                        status.value = { ...data };
                        
                        if (data.config) {
                            config.value = data.config;
                            if (!initLoaded.value && !silent) {
                                form.value.modelName = data.config.model_name || 'gemini-1.5-flash';
                                form.value.proxyUrl = data.config.proxy_url || '';
                                taskConfig.value = data.config.tasks_config;
                                taskTargetFolder.value = data.config.task_target_path;
                                dedupeTargetPath.value = data.config.dedupe_target_path;
                                initLoaded.value = true;
                            }
                        }

                        isBusy.value = data.status !== 'idle' && data.status !== 'done' && data.status !== 'error';
                        
                        // 状态完成后，如果列表是空的，自动加载第一页
                        if ((data.status === 'done' || data.status === 'idle') && results.value.length === 0) {
                            if (data.results_count > 0 || data.candidates_count > 0) {
                                loadDedupePage(1);
                            }
                        }
                    } finally {
                        if (silent) isSilentPolling.value = false;
                    }
                };

                // ✅ 加载去重数据 (分页)
                const loadDedupePage = async (page) => {
                    if (page < 1) return;
                    
                    // 确定加载哪个接口 (AI结果优先)
                    const targetApi = (status.value.results_count > 0 && (!isAiResult.value || results.value.length > 0)) 
                                      ? '/api/results' 
                                      : '/api/candidates';
                    
                    // 标记当前显示的是 AI 结果还是模糊匹配结果
                    isAiResult.value = (targetApi === '/api/results');

                    try {
                        const data = await apiCall(`${targetApi}?page=${page}&page_size=20`);
                        results.value = data.results;
                        dedupePage.value = data.page;
                        dedupeTotalPages.value = data.total_pages;
                    } catch (e) {
                        console.error("加载去重数据失败", e);
                    }
                };

                const fetchDirs = async (path) => {
                    loadingDirs.value = true;
                    try {
                        const url = path ? `/api/dirs?path=${encodeURIComponent(path)}` : '/api/dirs';
                        const data = await apiCall(url);
                        subDirs.value = data.subdirs;
                        currentNavPath.value = data.current_path;
                        parentNavPath.value = data.parent_path;
                        isNavRoot.value = data.is_root;
                        folderSelectorList.value = data.subdirs;
                    } finally {
                        loadingDirs.value = false;
                    }
                };

                const refreshFiles = async () => {
                    loadingFiles.value = true;
                    try {
                        const data = await apiCall('/api/files');
                        allFiles.value = data.files;
                        currentPage.value = 1;
                    } finally {
                        loadingFiles.value = false;
                    }
                };

                const scanFolder = async (path) => {
                    isScanningPath.value = path;
                    isBusy.value = true;
                    results.value = [];
                    try {
                        await apiCall('/api/scan', 'POST', { path });
                        showToast('扫描已启动', 'success');
                        setTimeout(() => fetchStatus(false), 500);
                    } catch(e) {
                        isBusy.value = false;
                    } finally {
                        isScanningPath.value = '';
                    }
                };

                const startScanAll = async () => {
                    isBusy.value = true;
                    results.value = [];
                    await apiCall('/api/scan', 'POST', { path: dedupeTargetPath.value });
                    setTimeout(() => fetchStatus(false), 500);
                };

                const startAnalyze = async () => {
                    isBusy.value = true;
                    results.value = []; 
                    await apiCall('/api/analyze', 'POST');
                    setTimeout(() => fetchStatus(false), 500);
                };

                const isSelected = (path) => selectedFiles.value.includes(path);
                const toggleSelect = (path) => {
                    if (isSelected(path)) selectedFiles.value = selectedFiles.value.filter(p => p !== path);
                    else selectedFiles.value.push(path);
                };
                
                const deleteSelected = async () => {
                    if (!confirm(`确认删除 ${selectedFiles.value.length} 个文件?`)) return;
                    const res = await apiCall('/api/delete', 'POST', { paths: selectedFiles.value });
                    showToast(`删除成功: ${res.deleted.length}, 失败: ${res.failed.length}`, res.failed.length ? 'warning' : 'success');
                    selectedFiles.value = [];
                    // 删除后重新加载当前页
                    loadDedupePage(dedupePage.value);
                };

                const isFileSelected = (path) => managerSelection.value.includes(path);
                const toggleSelectAllFiles = () => {
                    if (isAllFilesSelected.value) managerSelection.value = [];
                    else managerSelection.value = paginatedFiles.value.map(f => f.path);
                };
                
                const deleteOne = async (file) => {
                    if (!confirm(`确认删除 ${file.filename}?`)) return;
                    await apiCall('/api/delete', 'POST', { paths: [file.path] });
                    allFiles.value = allFiles.value.filter(f => f.path !== file.path);
                    showToast('文件已删除', 'success');
                };

                const deleteManagerSelection = async () => {
                    if (!confirm(`确认删除 ${managerSelection.value.length} 个文件?`)) return;
                    const res = await apiCall('/api/delete', 'POST', { paths: managerSelection.value });
                    allFiles.value = allFiles.value.filter(f => !res.deleted.includes(f.path));
                    managerSelection.value = [];
                    showToast(`删除完成`, 'success');
                };

                const applyMetadata = async () => {
                    await apiCall('/api/update_meta', 'POST', { 
                        paths: managerSelection.value,
                        ...metaEdit.value
                    });
                    showToast('元数据更新请求已发送', 'success');
                    refreshFiles();
                };

                const fixSingleAI = async (file) => {
                    loadingAiFiles.value[file.path] = true;
                    try {
                        const res = await apiCall('/api/fix_meta_single', 'POST', { path: file.path });
                        if (res.status === 'success') {
                            showToast(`修复成功: ${res.data.artist} - ${res.data.title}`, 'success');
                            const idx = allFiles.value.findIndex(f => f.path === file.path);
                            if (idx !== -1) {
                                Object.assign(allFiles.value[idx], res.data);
                            }
                        }
                    } finally {
                        delete loadingAiFiles.value[file.path];
                    }
                };

                const applyRename = async () => {
                    const res = await apiCall('/api/rename', 'POST', {
                        paths: managerSelection.value,
                        pattern: renamePattern.value
                    });
                    showToast(`重命名成功: ${res.renamed} 个`, 'success');
                    managerSelection.value = [];
                    refreshFiles();
                };

                const saveConfig = async () => {
                    await apiCall('/api/config', 'POST', {
                        api_key: form.value.apiKey,
                        model_name: form.value.modelName,
                        proxy_url: form.value.proxyUrl,
                        dedupe_target_path: dedupeTargetPath.value
                    });
                    showToast('配置已保存', 'success');
                    initLoaded.value = false;
                    fetchStatus(false);
                };

                const fetchModels = async () => {
                    const data = await apiCall('/api/models');
                    availableModels.value = data.models;
                };

                const selectFolder = (path) => fetchDirs(path || config.value.music_dir);
                
                const selectTaskFolder = (path) => {
                    taskTargetFolder.value = path;
                    showFolderSelector.value = false;
                };

                const selectDedupeFolder = (path) => {
                    dedupeTargetPath.value = path;
                    showDedupeFolderSelector.value = false;
                };

                const saveTasksConfig = async () => {
                    await apiCall('/api/tasks/config', 'POST', {
                        tasks: taskConfig.value,
                        target_path: taskTargetFolder.value
                    });
                    showToast('任务配置已保存', 'success');
                };

                const runTask = async (taskId) => {
                    await apiCall(`/api/tasks/run/${taskId}`, 'POST');
                    showToast(`任务 ${taskId} 已启动`, 'success');
                    setTimeout(() => fetchLogs(false), 1000);
                };

                const fetchLogs = async (silent = false) => {
                    const data = await apiCall('/api/tasks/logs');
                    taskLogs.value = data.logs;
                };

                const connectWS = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/progress`);
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        status.value = data;
                        isBusy.value = data.status !== 'idle' && data.status !== 'done' && data.status !== 'error';
                        
                        if (data.status === 'done' && currentTab.value === 'dedupe') {
                            loadDedupePage(1); // 任务完成自动刷新第一页
                        }
                    };
                    
                    ws.onclose = () => {
                        setTimeout(connectWS, 10000); 
                    };
                };

                onMounted(() => {
                    fetchStatus(false);
                    fetchDirs();
                    refreshFiles();
                    fetchModels();
                    connectWS();
                    
                    setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            fetchStatus(true);
                            if (currentTab.value === 'tasks') fetchLogs(true);
                        }
                    }, 2000);
                });

                return {
                    currentTab, switchTab, isBusy, isSilentPolling, toast, toastIcon,
                    config, form, availableModels, status, progressPercent,
                    // Manager
                    subDirs, currentNavPath, currentNavPathName, parentNavPath, isNavRoot, fetchDirs,
                    fileSearch, pageSize, currentPage, totalPages, paginatedFiles, filteredFiles, allFiles,
                    refreshFiles, scanFolder, isScanningPath, loadingFiles, loadingDirs,
                    managerSelection, isAllFilesSelected, toggleSelectAllFiles,
                    isFileSelected, deleteOne, deleteManagerSelection,
                    metaEdit, applyMetadata,
                    renamePattern, previewRename, applyRename,
                    loadingAiFiles, fixSingleAI,
                    // Tasks
                    taskConfig, taskTargetFolder, showFolderSelector, selectTaskFolder,
                    folderSelectorList, saveTasksConfig, runTask, taskLogs, fetchLogs, getTaskName,
                    // Dedupe
                    results, isAiResult, selectedFiles, isSelected, toggleSelect, deleteSelected,
                    saveConfig, fetchModels, startScanAll, startAnalyze, selectFolder,
                    // Dedupe New
                    dedupeTargetPath, showDedupeFolderSelector, selectDedupeFolder,
                    dedupePage, dedupeTotalPages, loadDedupePage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
