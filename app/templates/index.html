<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 音乐去重助手</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app" class="container mx-auto p-6 max-w-5xl">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-600"><i class="fa-solid fa-music"></i> 音乐去重助手 (Gemini版)</h1>
            <div class="text-sm">
                <span v-if="config.has_key" class="text-green-600 font-bold"><i class="fa-solid fa-check-circle"></i> 已连接: {{ config.model_name }}</span>
                <span v-else class="text-red-500"><i class="fa-solid fa-exclamation-triangle"></i> 未配置 API Key</span>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. 系统配置</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <input type="password" v-model="form.apiKey" placeholder="输入以 AIza 开头的 Key" 
                        class="border p-2 rounded w-full focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择模型</label>
                    <select v-model="form.modelName" class="border p-2 rounded w-full bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (推荐: 快速/便宜)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (更强: 适合复杂判断)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (最新)</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button @click="saveConfig" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">
                    <i class="fa-solid fa-save"></i> 保存配置
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. 扫描与分析</h2>
            
            <div class="flex flex-wrap gap-4 mb-4">
                <button @click="startScan" :disabled="isBusy" 
                    class="bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition flex-1">
                    <i class="fa-solid fa-magnifying-glass"></i> 第一步: 扫描本地文件
                </button>
                <button @click="startAnalyze" :disabled="isBusy || status.candidates_count === 0" 
                    class="bg-purple-500 text-white px-6 py-3 rounded hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition flex-1">
                    <i class="fa-solid fa-robot"></i> 第二步: AI 智能分析 ({{ status.candidates_count }} 组)
                </button>
            </div>

            <div class="bg-gray-50 p-4 rounded border border-gray-200">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span><strong>当前状态:</strong> {{ getStatusText(status.status) }}</span>
                    <span v-if="status.total > 0">{{ status.progress }} / {{ status.total }}</span>
                </div>
                <div v-if="isBusy" class="w-full bg-gray-200 rounded-full h-2.5 mb-2 overflow-hidden">
                    <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" :style="{ width: progressPercent + '%' }"></div>
                </div>
                <p class="text-gray-500 text-sm">{{ status.message }}</p>
            </div>
        </div>

        <div v-if="showResults" class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-semibold text-gray-800">3. 结果处理 (共 {{ results.length }} 组)</h2>
                <div v-if="selectedFiles.length > 0">
                    <span class="text-red-600 font-bold mr-4">已选中 {{ selectedFiles.length }} 个文件</span>
                    <button @click="deleteSelected" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 shadow-lg transition">
                        <i class="fa-solid fa-trash"></i> 确认删除
                    </button>
                </div>
            </div>

            <div v-if="results.length === 0" class="text-center py-10 text-gray-500">
                <i class="fa-solid fa-check-double text-4xl mb-4 text-green-500"></i>
                <p>太棒了！AI 没有发现重复文件。</p>
            </div>

            <div v-for="(group, gIndex) in results" :key="gIndex" class="border rounded-lg p-4 mb-6 bg-gray-50 hover:shadow-md transition">
                <div class="mb-3 flex justify-between items-center">
                    <span class="font-bold text-gray-700 bg-yellow-100 px-2 py-1 rounded text-sm">
                        <i class="fa-solid fa-lightbulb text-yellow-500"></i> AI 建议: {{ group.reason }}
                    </span>
                </div>
                
                <div class="space-y-2">
                    <div v-for="file in group.files" :key="file.path" 
                         class="flex items-center justify-between bg-white p-3 rounded border cursor-pointer transition select-none"
                         :class="{'border-red-500 bg-red-50 ring-1 ring-red-500': isSelected(file.path), 'hover:border-blue-300': !isSelected(file.path)}"
                         @click="toggleSelect(file.path)">
                        
                        <div class="flex items-center gap-4 overflow-hidden">
                            <div class="flex-shrink-0">
                                <i v-if="isSelected(file.path)" class="fa-regular fa-square-check text-2xl text-red-500"></i>
                                <i v-else class="fa-regular fa-square text-2xl text-gray-300"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="font-bold truncate text-gray-800">{{ file.filename }}</div>
                                <div class="text-xs text-gray-500 font-mono truncate" :title="file.path">{{ file.path }}</div>
                                <div class="text-xs mt-1 text-gray-600 flex gap-2">
                                    <span class="bg-gray-100 px-2 py-0.5 rounded border">{{ file.size_mb }} MB</span>
                                    <span class="bg-gray-100 px-2 py-0.5 rounded border">{{ file.bitrate }} kbps</span>
                                    <span class="bg-gray-100 px-2 py-0.5 rounded border">{{ file.duration }}秒</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    form: {
                        apiKey: '',
                        modelName: 'gemini-1.5-flash'
                    },
                    config: { has_key: false, masked_key: '', model_name: '' },
                    status: { status: 'idle', message: '等待操作...', candidates_count: 0, progress: 0, total: 100 },
                    results: [],
                    selectedFiles: [],
                    pollInterval: null
                }
            },
            computed: {
                isBusy() {
                    return this.status.status === 'scanning' || this.status.status === 'analyzing';
                },
                progressPercent() {
                    if (this.status.total === 0) return 0;
                    return Math.min(100, Math.round((this.status.progress / this.status.total) * 100));
                },
                showResults() {
                    // 当有结果 或者 状态是 done 时显示
                    return this.results.length > 0 || this.status.status === 'done';
                }
            },
            mounted() {
                this.pollStatus();
                this.pollInterval = setInterval(this.pollStatus, 2000);
            },
            methods: {
                getStatusText(s) {
                    const map = {
                        'idle': '空闲',
                        'scanning': '正在扫描',
                        'analyzing': 'AI 分析中',
                        'done': '完成',
                        'error': '错误'
                    };
                    return map[s] || s;
                },
                async saveConfig() {
                    if(!this.form.apiKey) return alert("请输入 API Key");
                    try {
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                api_key: this.form.apiKey,
                                model_name: this.form.modelName
                            })
                        });
                        if(res.ok) {
                            alert("配置已保存！");
                            this.pollStatus(); // 刷新状态
                        }
                    } catch(e) { alert("保存失败: " + e); }
                },
                async startScan() {
                    try { await fetch('/api/scan', { method: 'POST' }); } catch(e) { console.error(e); }
                },
                async startAnalyze() {
                    try { await fetch('/api/analyze', { method: 'POST' }); } catch(e) { console.error(e); }
                },
                async pollStatus() {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        
                        // 首次加载或后端有配置更新时，同步到表单
                        if (data.config && (!this.config.has_key || this.config.model_name !== data.config.model_name)) {
                            this.config = data.config;
                            // 如果表单是空的，填入后端回显的值（Key不回显完整值，只显示占位）
                            if(!this.form.apiKey && data.config.has_key) this.form.apiKey = data.config.masked_key; 
                            if(data.config.model_name) this.form.modelName = data.config.model_name;
                        }

                        this.status = data;
                        
                        // 如果状态完成且本地没有结果，拉取结果
                        if (this.status.status === 'done' && this.results.length === 0) {
                            await this.fetchResults();
                        }
                    } catch(e) { console.error("Polling error", e); }
                },
                async fetchResults() {
                    const res = await fetch('/api/results');
                    const data = await res.json();
                    this.results = data.results;
                },
                isSelected(path) {
                    return this.selectedFiles.includes(path);
                },
                toggleSelect(path) {
                    if (this.isSelected(path)) {
                        this.selectedFiles = this.selectedFiles.filter(p => p !== path);
                    } else {
                        this.selectedFiles.push(path);
                    }
                },
                async deleteSelected() {
                    if (!confirm(`确定要永久删除这 ${this.selectedFiles.length} 个文件吗？\n删除后不可恢复！`)) return;
                    
                    try {
                        const res = await fetch('/api/delete', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ paths: this.selectedFiles })
                        });
                        const data = await res.json();
                        alert(`成功删除: ${data.deleted.length} 个\n失败: ${data.failed.length} 个`);
                        
                        // 从界面移除已删除的文件
                        this.results.forEach(group => {
                            group.files = group.files.filter(f => !data.deleted.includes(f.path));
                        });
                        // 移除只剩一个文件的组
                        this.results = this.results.filter(g => g.files.length > 1);
                        this.selectedFiles = [];
                    } catch(e) { alert("请求失败: " + e); }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
