<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐管家 & AI 去重</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col">
    <div id="app" class="h-full flex flex-col">
        <header class="bg-white shadow z-10">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <i class="fa-solid fa-music"></i> 音乐管家
                </h1>
                
                <div class="flex gap-4">
                    <button @click="currentTab = 'dedupe'" 
                        :class="{'text-indigo-600 border-b-2 border-indigo-600': currentTab === 'dedupe', 'text-gray-500': currentTab !== 'dedupe'}"
                        class="px-4 py-2 font-medium transition">
                        <i class="fa-solid fa-clone"></i> AI 去重
                    </button>
                    <button @click="currentTab = 'manager'" 
                        :class="{'text-indigo-600 border-b-2 border-indigo-600': currentTab === 'manager', 'text-gray-500': currentTab !== 'manager'}"
                        class="px-4 py-2 font-medium transition">
                        <i class="fa-solid fa-folder-open"></i> 文件管理
                    </button>
                </div>

                <div class="text-sm">
                    <span v-if="config.has_key" class="text-green-600 font-bold"><i class="fa-solid fa-check-circle"></i> {{ config.model_name }}</span>
                    <span v-else class="text-red-500"><i class="fa-solid fa-exclamation-triangle"></i> 未配置 API</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden container mx-auto p-6">
            
            <div v-if="currentTab === 'dedupe'" class="h-full overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm">
                        <h2 class="font-bold mb-3 text-gray-700">配置</h2>
                        <div class="space-y-3">
                            <input type="password" v-model="form.apiKey" placeholder="Gemini API Key" class="w-full border p-2 rounded text-sm">
                            <div class="flex gap-2">
                                <input list="model-list" v-model="form.modelName" placeholder="模型名称" class="w-full border p-2 rounded text-sm">
                                <datalist id="model-list"><option v-for="m in availableModels" :value="m">{{ m }}</option></datalist>
                                <button @click="fetchModels" class="bg-gray-200 px-3 rounded text-gray-600"><i class="fa-solid fa-sync"></i></button>
                            </div>
                            <input type="text" v-model="form.proxyUrl" placeholder="HTTP 代理 (http://IP:PORT)" class="w-full border p-2 rounded text-sm">
                            <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 text-sm">保存配置</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-lg shadow-sm flex flex-col justify-between">
                        <div>
                            <h2 class="font-bold mb-3 text-gray-700">任务控制</h2>
                            <p class="text-sm text-gray-500 mb-4">{{ status.message }}</p>
                            <div v-if="isBusy" class="w-full bg-gray-200 rounded-full h-2 mb-4">
                                <div class="bg-blue-600 h-2 rounded-full transition-all" :style="{ width: progressPercent + '%' }"></div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button @click="startScan" :disabled="isBusy" class="flex-1 bg-blue-500 text-white py-3 rounded hover:bg-blue-600 disabled:opacity-50">
                                1. 扫描
                            </button>
                            <button @click="startAnalyze" :disabled="isBusy || status.candidates_count === 0" class="flex-1 bg-purple-500 text-white py-3 rounded hover:bg-purple-600 disabled:opacity-50">
                                2. AI 分析
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="results.length > 0" class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">重复分析结果 ({{ results.length }} 组)</h3>
                        <button v-if="selectedFiles.length > 0" @click="deleteSelected" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700">
                            删除选中 ({{ selectedFiles.length }})
                        </button>
                    </div>
                    <div v-for="(group, idx) in results" :key="idx" class="border rounded mb-4 p-4 bg-gray-50">
                        <div class="text-sm text-yellow-700 bg-yellow-100 p-2 rounded mb-2"><i class="fa-solid fa-lightbulb"></i> {{ group.reason }}</div>
                        <div class="space-y-1">
                            <div v-for="file in group.files" :key="file.path" 
                                @click="toggleSelect(file.path)"
                                class="flex items-center gap-3 p-2 bg-white border rounded cursor-pointer hover:border-blue-400"
                                :class="{'ring-2 ring-red-500 border-red-500': isSelected(file.path)}">
                                <i :class="isSelected(file.path) ? 'fa-regular fa-square-check text-red-500' : 'fa-regular fa-square text-gray-300'"></i>
                                <div class="text-sm overflow-hidden">
                                    <div class="font-bold">{{ file.filename }}</div>
                                    <div class="text-gray-500 text-xs">{{ file.size_mb }}MB | {{ file.bitrate }}kbps | {{ file.path }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="h-full flex gap-6">
                <div class="flex-1 bg-white rounded-lg shadow-sm flex flex-col overflow-hidden">
                    <div class="p-4 border-b flex gap-3 items-center flex-wrap">
                        <input type="text" v-model="fileSearch" placeholder="搜索艺术家、标题或文件名..." class="flex-1 border p-2 rounded text-sm min-w-[200px]">
                        
                        <select v-model.number="pageSize" @change="currentPage = 1" class="border p-2 rounded text-sm">
                            <option :value="50">50条/页</option>
                            <option :value="100">100条/页</option>
                            <option :value="300">300条/页</option>
                            <option :value="500">500条/页</option>
                        </select>
                        
                        <button @click="refreshFiles" class="bg-gray-100 px-3 py-2 rounded hover:bg-gray-200"><i class="fa-solid fa-sync"></i></button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-2">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="p-2 w-8"><input type="checkbox" @change="toggleSelectAllFiles" :checked="isAllFilesSelected"></th>
                                    <th class="p-2 w-16 text-center">操作</th> <th class="p-2">文件名</th>
                                    <th class="p-2">艺术家</th>
                                    <th class="p-2">标题</th>
                                    <th class="p-2">专辑</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="file in paginatedFiles" :key="file.path" class="border-b hover:bg-blue-50 group">
                                    <td class="p-2"><input type="checkbox" :value="file.path" v-model="managerSelection"></td>
                                    <td class="p-2 flex justify-center gap-2">
                                        <button @click="fixSingleAI(file)" title="AI 智能修复" 
                                            class="text-indigo-400 hover:text-indigo-600 disabled:opacity-30">
                                            <i class="fa-solid fa-wand-magic-sparkles" :class="{'loading-spin': loadingFiles[file.path]}"></i>
                                        </button>
                                        <button @click="deleteOne(file)" title="删除文件" 
                                            class="text-red-300 hover:text-red-600">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                    <td class="p-2 max-w-xs truncate text-gray-700" :title="file.filename">{{ file.filename }}</td>
                                    <td class="p-2 max-w-xs truncate text-gray-500">{{ file.artist }}</td>
                                    <td class="p-2 max-w-xs truncate text-gray-500">{{ file.title }}</td>
                                    <td class="p-2 max-w-xs truncate text-gray-500">{{ file.album }}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div v-if="allFiles.length === 0" class="text-center text-gray-500 mt-10">
                            请先在“AI 去重”页点击“扫描”来加载文件库
                        </div>
                    </div>

                    <div class="p-2 bg-gray-50 text-xs text-gray-500 border-t flex justify-between items-center">
                        <div>
                            显示 {{ paginatedFiles.length }} / 共 {{ filteredFiles.length }} (总 {{ allFiles.length }}) | 已选 {{ managerSelection.length }}
                        </div>
                        
                        <div class="flex gap-2 items-center" v-if="totalPages > 1">
                            <button @click="currentPage--" :disabled="currentPage === 1" class="px-2 py-1 bg-white border rounded disabled:opacity-50">上一页</button>
                            <span>{{ currentPage }} / {{ totalPages }}</span>
                            <button @click="currentPage++" :disabled="currentPage === totalPages" class="px-2 py-1 bg-white border rounded disabled:opacity-50">下一页</button>
                        </div>
                    </div>
                </div>

                <div class="w-80 flex flex-col gap-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-tags"></i> 批量修改标签
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500">艺术家 (Artist)</label>
                                <input type="text" v-model="metaEdit.artist" placeholder="保持原样" class="w-full border p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">标题 (Title)</label>
                                <input type="text" v-model="metaEdit.title" placeholder="保持原样" class="w-full border p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">专辑 (Album)</label>
                                <input type="text" v-model="metaEdit.album" placeholder="保持原样" class="w-full border p-2 rounded text-sm">
                            </div>
                            <button @click="applyMetadata" :disabled="managerSelection.length === 0" 
                                class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 disabled:opacity-50 text-sm">
                                应用到 {{ managerSelection.length }} 个文件
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-i-cursor"></i> 批量重命名
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500">命名模式</label>
                                <input type="text" v-model="renamePattern" class="w-full border p-2 rounded text-sm">
                                <div class="flex gap-1 mt-1 flex-wrap">
                                    <span @click="renamePattern += '{artist}'" class="cursor-pointer px-2 py-0.5 bg-gray-200 rounded text-xs hover:bg-gray-300">{artist}</span>
                                    <span @click="renamePattern += '{title}'" class="cursor-pointer px-2 py-0.5 bg-gray-200 rounded text-xs hover:bg-gray-300">{title}</span>
                                    <span @click="renamePattern += '{album}'" class="cursor-pointer px-2 py-0.5 bg-gray-200 rounded text-xs hover:bg-gray-300">{album}</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                预览: <span class="font-mono text-indigo-600">{{ previewRename }}</span>.mp3
                            </div>
                            <button @click="applyRename" :disabled="managerSelection.length === 0"
                                class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50 text-sm">
                                重命名 {{ managerSelection.length }} 个文件
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentTab: 'dedupe',
                    form: { apiKey: '', modelName: 'gemini-1.5-flash-002', proxyUrl: '' },
                    availableModels: [],
                    config: { has_key: false, masked_key: '', model_name: '', proxy_url: '' },
                    status: { status: 'idle', message: '等待操作...', candidates_count: 0, progress: 0, total: 100 },
                    results: [],
                    selectedFiles: [], 
                    
                    // 文件管理相关
                    allFiles: [],
                    fileSearch: '',
                    managerSelection: [],
                    metaEdit: { artist: '', title: '', album: '' },
                    renamePattern: '{artist} - {title}',
                    
                    // 分页 & Loading
                    currentPage: 1,
                    pageSize: 50,
                    loadingFiles: {}, // 用于存储单个文件 AI 修复时的 loading 状态
                    
                    pollInterval: null
                }
            },
            computed: {
                isBusy() { return this.status.status === 'scanning' || this.status.status === 'analyzing'; },
                progressPercent() {
                    if (this.status.total === 0) return 0;
                    return Math.min(100, Math.round((this.status.progress / this.status.total) * 100));
                },
                filteredFiles() {
                    if (!this.fileSearch) return this.allFiles;
                    const q = this.fileSearch.toLowerCase();
                    return this.allFiles.filter(f => 
                        f.filename.toLowerCase().includes(q) || 
                        f.artist.toLowerCase().includes(q) || 
                        f.title.toLowerCase().includes(q)
                    );
                },
                // 分页逻辑
                paginatedFiles() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredFiles.slice(start, end);
                },
                totalPages() {
                    return Math.ceil(this.filteredFiles.length / this.pageSize);
                },
                isAllFilesSelected() {
                    return this.paginatedFiles.length > 0 && this.paginatedFiles.every(f => this.managerSelection.includes(f.path));
                },
                previewRename() {
                    let sample = {artist: 'Jay Chou', title: 'Sunny Day', album: 'Ye Hui Mei'};
                    if (this.managerSelection.length > 0) {
                        const file = this.allFiles.find(f => f.path === this.managerSelection[0]);
                        if (file) sample = file;
                    }
                    return this.renamePattern
                        .replace('{artist}', sample.artist || 'Unknown')
                        .replace('{title}', sample.title || sample.filename)
                        .replace('{album}', sample.album || 'Unknown');
                }
            },
            watch: {
                currentTab(newVal) {
                    if (newVal === 'manager' && this.allFiles.length === 0) {
                        this.refreshFiles();
                    }
                },
                // 搜索或页码变化时，重置 selection 或保持 (这里简单处理：保持ID但UI可能不同步，暂不清除)
                fileSearch() { this.currentPage = 1; }
            },
            mounted() {
                this.pollStatus();
                this.pollInterval = setInterval(this.pollStatus, 2000);
            },
            methods: {
                // ... (原有配置、扫描、AI去重逻辑) ...
                async saveConfig() {
                    if(!this.form.apiKey) return alert("请输入 API Key");
                    try {
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ api_key: this.form.apiKey, model_name: this.form.modelName, proxy_url: this.form.proxyUrl })
                        });
                        if(res.ok) { alert("配置已保存！"); this.pollStatus(); this.fetchModels(); }
                    } catch(e) { alert("保存失败: " + e); }
                },
                async fetchModels() {
                    try {
                        const res = await fetch('/api/models');
                        const data = await res.json();
                        if (data.models) this.availableModels = data.models;
                    } catch(e) {}
                },
                async startScan() { await fetch('/api/scan', { method: 'POST' }); },
                async startAnalyze() { await fetch('/api/analyze', { method: 'POST' }); },
                async pollStatus() {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        if (data.config && (!this.config.has_key || this.config.model_name !== data.config.model_name)) {
                            this.config = data.config;
                            if(!this.form.apiKey && data.config.has_key) this.form.apiKey = data.config.masked_key; 
                            if(data.config.model_name) this.form.modelName = data.config.model_name;
                            if(data.config.proxy_url) this.form.proxyUrl = data.config.proxy_url;
                        }
                        this.status = data;
                        if (this.status.status === 'done' && this.results.length === 0) await this.fetchResults();
                    } catch(e) {}
                },
                async fetchResults() {
                    const res = await fetch('/api/results');
                    const data = await res.json();
                    this.results = data.results;
                },
                isSelected(path) { return this.selectedFiles.includes(path); },
                toggleSelect(path) {
                    if (this.isSelected(path)) this.selectedFiles = this.selectedFiles.filter(p => p !== path);
                    else this.selectedFiles.push(path);
                },
                async deleteSelected() {
                    if (!confirm(`确定删除 ${this.selectedFiles.length} 个文件？`)) return;
                    await fetch('/api/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ paths: this.selectedFiles }) });
                    this.selectedFiles = [];
                    this.fetchResults();
                    this.refreshFiles();
                },

                // === 文件管理新方法 ===
                async refreshFiles() {
                    const res = await fetch('/api/files');
                    const data = await res.json();
                    this.allFiles = data.files;
                },
                toggleSelectAllFiles() {
                    if (this.isAllFilesSelected) {
                        // 取消全选当前页
                        const currentPaths = this.paginatedFiles.map(f => f.path);
                        this.managerSelection = this.managerSelection.filter(p => !currentPaths.includes(p));
                    } else {
                        // 全选当前页
                        const currentPaths = this.paginatedFiles.map(f => f.path);
                        // 合并去重
                        this.managerSelection = [...new Set([...this.managerSelection, ...currentPaths])];
                    }
                },
                async applyMetadata() {
                    if (!confirm(`确定修改 ${this.managerSelection.length} 个文件的标签吗？`)) return;
                    const body = { paths: this.managerSelection, artist: this.metaEdit.artist || null, title: this.metaEdit.title || null, album: this.metaEdit.album || null };
                    await fetch('/api/update_meta', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                    this.refreshFiles();
                    this.managerSelection = [];
                    this.metaEdit = {artist:'', title:'', album:''};
                },
                async applyRename() {
                    if (!confirm(`确定重命名 ${this.managerSelection.length} 个文件吗？`)) return;
                    await fetch('/api/rename', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ paths: this.managerSelection, pattern: this.renamePattern }) 
                    });
                    this.refreshFiles();
                    this.managerSelection = [];
                },
                // 单文件删除
                async deleteOne(file) {
                    if (!confirm(`确定删除文件: ${file.filename} ?`)) return;
                    await fetch('/api/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ paths: [file.path] }) });
                    // 本地快速移除
                    this.allFiles = this.allFiles.filter(f => f.path !== file.path);
                },
                // 单文件 AI 修复
                async fixSingleAI(file) {
                    this.loadingFiles[file.path] = true; // 开启 loading 动画
                    try {
                        const res = await fetch('/api/fix_meta_single', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ path: file.path })
                        });
                        const data = await res.json();
                        if (data.success) {
                            // 成功提示并刷新
                            // alert(`修复成功！\n标题: ${data.data.title}\n艺术家: ${data.data.artist}`);
                            await this.refreshFiles();
                        } else {
                            alert("AI 修复失败: " + (data.error || "未知错误"));
                        }
                    } catch (e) {
                        alert("请求失败: " + e);
                    } finally {
                        this.loadingFiles[file.path] = false; // 关闭 loading
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
