<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐管家 & AI 去重</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .col-checkbox { width: 40px; }
        .col-action { width: 90px; text-align: center; }
        .col-file { width: 220px; }
        .log-box { font-family: 'Courier New', Courier, monospace; font-size: 12px; line-height: 1.4; }
        
        .toast {
            position: fixed; top: 80px; right: 20px; z-index: 9999;
            min-width: 300px; max-width: 500px; padding: 12px 16px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        
        .progress-bar { transition: width 0.3s ease-out; }
        tr.selected { background: #fef3c7 !important; border-left: 3px solid #f59e0b; }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .tooltip { position: relative; }
        .tooltip:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); padding: 4px 8px; background: #1f2937;
            color: white; font-size: 11px; white-space: nowrap;
            border-radius: 4px; margin-bottom: 4px; z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">
    <div id="app" class="h-full flex flex-col">
        <!-- Toast 通知 -->
        <transition name="fade">
            <div v-if="toast.show" :class="['toast', `toast-${toast.type}`]" class="fade-in">
                <div class="flex items-center gap-2">
                    <i :class="toastIcon"></i>
                    <span>{{ toast.message }}</span>
                </div>
            </div>
        </transition>

        <!-- 顶部导航 -->
        <header class="bg-white shadow z-10 shrink-0">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <i class="fa-solid fa-music"></i> 音乐管家
                </h1>
                
                <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                    <button @click="switchTab('manager')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'manager', 'text-gray-500 hover:text-gray-700': currentTab !== 'manager'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-folder-open"></i> 文件管理
                    </button>
                    <button @click="switchTab('tasks')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'tasks', 'text-gray-500 hover:text-gray-700': currentTab !== 'tasks'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-clock"></i> 计划任务
                    </button>
                    <button @click="switchTab('dedupe')" 
                        :class="{'bg-white text-indigo-600 shadow-sm': currentTab === 'dedupe', 'text-gray-500 hover:text-gray-700': currentTab !== 'dedupe'}"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-clone"></i> AI 去重
                    </button>
                </div>

                <div class="text-sm flex items-center gap-3">
                    <div v-if="isBusy" class="flex items-center gap-2 text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                        <i class="fa-solid fa-circle-notch loading-spin"></i> 处理中...
                    </div>
                    <span v-if="config.has_key" class="text-green-600 font-bold flex items-center gap-1 tooltip" data-tip="API 已配置">
                        <i class="fa-solid fa-check-circle"></i> {{ config.model_name }}
                    </span>
                    <span v-else class="text-red-500 flex items-center gap-1 tooltip" data-tip="请前往配置页设置 API Key">
                        <i class="fa-solid fa-exclamation-triangle"></i> 未配置 API
                    </span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden container mx-auto p-4 sm:p-6">
            
            <!-- 文件管理 Tab -->
            <div v-show="currentTab === 'manager'" class="h-full flex gap-4">
                
                <!-- 左侧目录树 -->
                <div class="w-72 bg-white rounded-lg shadow-sm flex flex-col overflow-hidden shrink-0 border border-gray-200">
                    <div class="p-3 border-b bg-gray-50 font-bold text-gray-700 text-sm flex justify-between items-center">
                        <span class="truncate pr-2 text-xs font-mono" :title="currentNavPath || '根目录'">
                            <i class="fa-solid fa-folder-tree mr-1 text-indigo-500"></i> {{ currentNavPathName }}
                        </span>
                        <div class="flex gap-1">
                            <button v-if="!isNavRoot" @click="fetchDirs(parentNavPath)" class="text-gray-500 hover:text-indigo-600 p-1 rounded hover:bg-gray-200 tooltip" data-tip="返回上级">
                                <i class="fa-solid fa-level-up-alt"></i>
                            </button>
                            <button @click="fetchDirs(currentNavPath)" class="text-gray-500 hover:text-indigo-600 p-1 rounded hover:bg-gray-200 tooltip" data-tip="刷新目录">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-2 text-sm">
                        <div @click="selectFolder('')" class="cursor-pointer px-3 py-2 rounded mb-1 flex justify-between items-center hover:bg-gray-100 transition border border-transparent"
                            :class="{'bg-indigo-50 text-indigo-700 font-bold border-indigo-100': currentFolder === ''}">
                            <span><i class="fa-solid fa-music mr-2 text-gray-400"></i> 全部已加载</span>
                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">{{ allFiles.length }}</span>
                        </div>
                        
                        <hr class="my-2 border-gray-100">

                        <div v-if="loadingDirs" class="space-y-2">
                            <div v-for="i in 3" :key="i" class="skeleton h-8 rounded"></div>
                        </div>
                        
                        <div v-else-if="subDirs.length === 0" class="text-center text-gray-400 py-4 italic text-xs">
                            当前目录下无子文件夹
                        </div>
                        
                        <div v-else v-for="dir in subDirs" :key="dir.path"
                            class="group flex items-center justify-between px-3 py-2 rounded mb-1 hover:bg-gray-100 transition border border-transparent"
                            :class="{'bg-indigo-50 border-indigo-100': filterFolder === dir.path}">
                            
                            <div @click="fetchDirs(dir.path)" class="flex-1 cursor-pointer truncate mr-2 text-gray-700 hover:text-indigo-700 select-none" :title="dir.name">
                                <i class="fa-regular fa-folder mr-2 text-yellow-500 group-hover:text-yellow-600"></i> {{ dir.name }}
                            </div>
                            
                            <button @click.stop="scanFolder(dir.path)" :disabled="isBusy" class="text-gray-300 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition-colors tooltip" data-tip="扫描此文件夹并加载">
                                <i class="fa-solid fa-magnifying-glass" :class="{'text-blue-500 loading-spin': isScanningPath === dir.path}"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="isBusy" class="p-2 bg-blue-50 text-xs text-blue-700 border-t flex items-center gap-2">
                        <i class="fa-solid fa-circle-notch loading-spin"></i>
                        <span class="truncate">{{ status.message }}</span>
                    </div>
                </div>

                <!-- 中间文件列表 -->
                <div class="flex-1 bg-white rounded-lg shadow-sm flex flex-col overflow-hidden min-w-0 border border-gray-200">
                    <div class="p-3 border-b flex gap-2 items-center flex-wrap bg-gray-50">
                        <div class="relative flex-1 min-w-[200px]">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                            <input type="text" v-model="fileSearch" @input="debounceSearch" placeholder="搜索文件名、标题、艺术家..." 
                                class="w-full border border-gray-300 p-1.5 pl-8 rounded text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">每页:</span>
                            <select v-model.number="pageSize" @change="currentPage = 1" class="border border-gray-300 p-1.5 rounded text-sm w-20 bg-white focus:outline-none">
                                <option :value="50">50</option>
                                <option :value="100">100</option>
                                <option :value="300">300</option>
                                <option :value="500">500</option>
                            </select>
                        </div>
                        
                        <button @click="refreshFiles" :disabled="loadingFiles" class="bg-white border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-50 text-gray-600 transition disabled:opacity-50 tooltip" data-tip="刷新列表">
                            <i class="fa-solid fa-sync" :class="{'loading-spin': loadingFiles}"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <table class="w-full text-sm text-left table-fixed border-collapse">
                            <thead class="bg-gray-50 sticky top-0 shadow-sm z-10 text-gray-600 text-xs uppercase tracking-wider font-semibold">
                                <tr>
                                    <th class="p-2 col-checkbox border-b border-gray-200 text-center">
                                        <input type="checkbox" @change="toggleSelectAllFiles" :checked="isAllFilesSelected" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </th>
                                    <th class="p-2 col-action border-b border-gray-200">操作</th>
                                    <th class="p-2 col-file border-b border-gray-200">文件名</th>
                                    <th class="p-2 border-b border-gray-200">标题</th>
                                    <th class="p-2 border-b border-gray-200">艺术家</th>
                                    <th class="p-2 border-b border-gray-200">专辑</th>
                                    <th class="p-2 border-b border-gray-200">专辑艺术家</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white">
                                <tr v-if="loadingFiles" v-for="i in pageSize" :key="'skeleton-'+i">
                                    <td colspan="7" class="p-2"><div class="skeleton h-8 rounded"></div></td>
                                </tr>
                                
                                <tr v-else v-for="file in paginatedFiles" :key="file.path" class="group hover:bg-blue-50 transition-colors" :class="{'selected': isFileSelected(file.path)}">
                                    <td class="p-2 text-center">
                                        <input type="checkbox" :value="file.path" v-model="managerSelection" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </td>
                                    <td class="p-2 flex justify-center gap-2">
                                        <button @click="fixSingleAI(file)" :disabled="loadingAiFiles[file.path]" 
                                            class="w-7 h-7 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-500 hover:bg-indigo-600 hover:text-white transition disabled:opacity-30 tooltip" data-tip="AI 智能识别并修复元数据">
                                            <i class="fa-solid fa-wand-magic-sparkles" :class="{'loading-spin': loadingAiFiles[file.path]}"></i>
                                        </button>
                                        <button @click="deleteOne(file)" class="w-7 h-7 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-600 hover:text-white transition tooltip" data-tip="删除文件">
                                            <i class="fa-solid fa-trash-alt"></i>
                                        </button>
                                    </td>
                                    <td class="p-2 truncate font-medium text-gray-700" :title="file.filename">{{ file.filename }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.title">{{ file.title }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.artist">{{ file.artist }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.album">{{ file.album }}</td>
                                    <td class="p-2 truncate text-gray-500" :title="file.album_artist">{{ file.album_artist }}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div v-if="!loadingFiles && allFiles.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="bg-gray-100 p-4 rounded-full mb-3"><i class="fa-solid fa-music text-3xl text-gray-300"></i></div>
                            <p class="text-sm font-medium">当前列表为空</p>
                            <p class="text-xs text-gray-400 mt-1">请在左侧选择文件夹并点击 <i class="fa-solid fa-magnifying-glass"></i> 进行扫描</p>
                        </div>
                    </div>

                    <div class="p-2 bg-gray-50 text-xs text-gray-500 border-t flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3">
                            <span>显示 {{ paginatedFiles.length }} / {{ filteredFiles.length }} (总缓存 {{ allFiles.length }})</span>
                            <span v-if="managerSelection.length > 0" class="text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded">已选 {{ managerSelection.length }}</span>
                        </div>
                        
                        <div class="flex gap-2 items-center" v-if="totalPages > 1">
                            <button @click="currentPage--" :disabled="currentPage === 1" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span class="min-w-[3rem] text-center font-mono">{{ currentPage }} / {{ totalPages }}</span>
                            <button @click="currentPage++" :disabled="currentPage === totalPages" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 右侧操作面板 - 此处省略部分代码,在代码部分2中继续 -->
<!-- 右侧操作面板 -->
                <div class="w-72 flex flex-col gap-4 overflow-y-auto shrink-0 pb-4">
                    <div v-if="managerSelection.length > 0" class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm slide-in">
                        <h3 class="font-bold text-red-700 mb-2 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-triangle-exclamation"></i> 危险操作区域
                        </h3>
                        <p class="text-xs text-red-500 mb-3">选中的文件将被永久物理删除，无法恢复!</p>
                        <button @click="deleteManagerSelection" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 text-sm shadow transition font-bold">
                            <i class="fa-solid fa-trash-can mr-1"></i> 确认删除 {{ managerSelection.length }} 个文件
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm pb-2 border-b">
                            <i class="fa-solid fa-tags text-indigo-500"></i> 批量修改标签
                        </h3>
                        <div class="space-y-3">
                            <div><label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">Artist</label>
                                <input type="text" v-model="metaEdit.artist" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"></div>
                            <div><label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">Album Artist</label>
                                <input type="text" v-model="metaEdit.album_artist" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"></div>
                            <div><label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">Title</label>
                                <input type="text" v-model="metaEdit.title" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"></div>
                            <div><label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">Album</label>
                                <input type="text" v-model="metaEdit.album" placeholder="保持原样" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"></div>
                            <button @click="applyMetadata" :disabled="managerSelection.length === 0" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50 disabled:bg-gray-400 text-sm transition mt-1 shadow-sm font-medium">
                                应用修改 ({{ managerSelection.length }})
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm pb-2 border-b">
                            <i class="fa-solid fa-i-cursor text-blue-500"></i> 批量重命名
                        </h3>
                        <div class="space-y-3">
                            <div><label class="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">Pattern</label>
                                <input type="text" v-model="renamePattern" class="w-full border border-gray-300 p-2 rounded text-sm font-mono text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition bg-gray-50">
                                <div class="flex gap-1.5 mt-2 flex-wrap">
                                    <button @click="renamePattern += '{artist}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] hover:bg-gray-200 border text-gray-600 transition">{artist}</button>
                                    <button @click="renamePattern += '{album_artist}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] hover:bg-gray-200 border text-gray-600 transition">{album_artist}</button>
                                    <button @click="renamePattern += '{title}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] hover:bg-gray-200 border text-gray-600 transition">{title}</button>
                                    <button @click="renamePattern += '{album}'" class="px-2 py-1 bg-gray-100 rounded text-[10px] hover:bg-gray-200 border text-gray-600 transition">{album}</button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 bg-blue-50 p-2 rounded border border-blue-100 break-all">
                                <span class="font-bold text-blue-800">预览:</span> <span class="font-mono text-blue-600">{{ previewRename }}</span>.mp3
                            </div>
                            <button @click="applyRename" :disabled="managerSelection.length === 0" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50 disabled:bg-gray-400 text-sm transition shadow-sm font-medium">
                                开始重命名 ({{ managerSelection.length }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 计划任务 Tab -->
            <div v-show="currentTab === 'tasks'" class="h-full flex gap-6">
                <div class="flex-1 overflow-y-auto pr-2">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-5 mb-6 shadow-sm">
                        <h2 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-crosshairs"></i> 计划任务作用域
                        </h2>
                        <div class="flex gap-3 items-end">
                            <div class="flex-1">
                                <label class="text-xs text-indigo-600 mb-1 block font-bold">目标文件夹 (所有自动任务将仅在此文件夹下执行)</label>
                                <div class="relative">
                                    <input type="text" v-model="taskTargetFolder" class="w-full border border-indigo-200 p-2.5 pl-3 rounded text-sm bg-white font-mono text-gray-600" readonly>
                                    <div class="absolute right-0 top-0 bottom-0 flex items-center pr-2">
                                        <div class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded cursor-pointer hover:bg-indigo-200" @click="showFolderSelector = !showFolderSelector">选择...</div>
                                    </div>
                                </div>
                                <div v-if="showFolderSelector" class="mt-2 bg-white border rounded shadow-lg max-h-48 overflow-y-auto absolute z-20 w-full lg:w-1/2">
                                    <div @click="selectTaskFolder(config.music_dir)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm font-bold text-indigo-600 border-b">/ (根目录)</div>
                                    <div v-for="dir in folderSelectorList" :key="dir.path" @click="selectTaskFolder(dir.path)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700 border-b border-gray-50 flex items-center">
                                        <i class="fa-regular fa-folder mr-2 text-yellow-500"></i> {{ dir.name }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:border-blue-300 transition-colors relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-lg"><i class="fa-solid fa-volume-high"></i></div>
                                        <div><h3 class="font-bold text-gray-800">音质去重</h3><p class="text-xs text-gray-500">同名文件保留 FLAC > MP3</p></div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="taskConfig.dedupe_quality.enabled" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg flex gap-2 items-center mb-3 border border-gray-100">
                                    <span class="text-xs font-mono text-gray-500 bg-white border px-1.5 rounded">Cron</span>
                                    <input type="text" v-model="taskConfig.dedupe_quality.cron" class="bg-transparent border-b border-dashed border-gray-300 text-sm w-full font-mono focus:outline-none focus:border-blue-500" placeholder="0 2 * * *">
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-xs text-gray-400">上次: {{ taskConfig.dedupe_quality.last_run || '从未运行' }}</div>
                                    <button @click="runTask('dedupe_quality')" class="bg-white border border-blue-200 text-blue-600 text-xs px-3 py-1.5 rounded-full hover:bg-blue-50 hover:border-blue-300 transition flex items-center gap-1">
                                        <i class="fa-solid fa-play"></i> 立即执行
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:border-yellow-300 transition-colors relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-yellow-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-lg flex items-center justify-center text-lg"><i class="fa-solid fa-scissors"></i></div>
                                        <div><h3 class="font-bold text-gray-800">短音频清理</h3><p class="text-xs text-gray-500">删除过短的音频片段</p></div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="taskConfig.clean_short.enabled" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                    </label>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg flex gap-3 items-center mb-3 border border-gray-100 flex-wrap">
                                    <div class="flex items-center gap-2 flex-1">
                                        <span class="text-xs font-mono text-gray-500 bg-white border px-1.5 rounded">Cron</span>
                                        <input type="text" v-model="taskConfig.clean_short.cron" class="bg-transparent border-b border-dashed border-gray-300 text-sm w-full font-mono focus:outline-none focus:border-yellow-500">
                                    </div>
                                    <div class="flex items-center gap-1 w-24">
                                        <span class="text-xs text-gray-500">秒&lt;</span>
                                        <input type="number" v-model.number="taskConfig.clean_short.min_duration" class="bg-white border p-1 rounded text-sm w-full h-6">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-xs text-gray-400">上次: {{ taskConfig.clean_short.last_run || '从未运行' }}</div>
                                    <button @click="runTask('clean_short')" class="bg-white border border-yellow-200 text-yellow-600 text-xs px-3 py-1.5 rounded-full hover:bg-yellow-50 hover:border-yellow-300 transition flex items-center gap-1">
                                        <i class="fa-solid fa-play"></i> 立即执行
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:border-green-300 transition-colors relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-green-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center text-lg"><i class="fa-solid fa-file-invoice"></i></div>
                                        <div><h3 class="font-bold text-gray-800">元数据提取</h3><p class="text-xs text-gray-500">生成 Emby NFO 及提取封面</p></div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="taskConfig.extract_meta.enabled" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg flex gap-2 items-center mb-3 border border-gray-100">
                                    <span class="text-xs font-mono text-gray-500 bg-white border px-1.5 rounded">Cron</span>
                                    <input type="text" v-model="taskConfig.extract_meta.cron" class="bg-transparent border-b border-dashed border-gray-300 text-sm w-full font-mono focus:outline-none focus:border-green-500" placeholder="0 4 * * *">
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-xs text-gray-400">上次: {{ taskConfig.extract_meta.last_run || '从未运行' }}</div>
                                    <button @click="runTask('extract_meta')" class="bg-white border border-green-200 text-green-600 text-xs px-3 py-1.5 rounded-full hover:bg-green-50 hover:border-green-300 transition flex items-center gap-1">
                                        <i class="fa-solid fa-play"></i> 立即执行
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:border-red-300 transition-colors relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-red-100 text-red-600 rounded-lg flex items-center justify-center text-lg"><i class="fa-solid fa-broom"></i></div>
                                        <div><h3 class="font-bold text-gray-800">冗余垃圾清理</h3><p class="text-xs text-gray-500">清理无音乐目录下的残留图片/NFO</p></div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="taskConfig.clean_junk.enabled" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                    </label>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg flex gap-2 items-center mb-3 border border-gray-100">
                                    <span class="text-xs font-mono text-gray-500 bg-white border px-1.5 rounded">Cron</span>
                                    <input type="text" v-model="taskConfig.clean_junk.cron" class="bg-transparent border-b border-dashed border-gray-300 text-sm w-full font-mono focus:outline-none focus:border-red-500" placeholder="0 5 * * *">
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-xs text-gray-400">上次: {{ taskConfig.clean_junk.last_run || '从未运行' }}</div>
                                    <button @click="runTask('clean_junk')" class="bg-white border border-red-200 text-red-600 text-xs px-3 py-1.5 rounded-full hover:bg-red-50 hover:border-red-300 transition flex items-center gap-1">
                                        <i class="fa-solid fa-play"></i> 立即执行
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button @click="saveTasksConfig" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg shadow-md hover:bg-indigo-700 transition flex items-center gap-2 font-bold">
                            <i class="fa-solid fa-save"></i> 保存计划设置
                        </button>
                    </div>
                </div>

                <div class="w-80 bg-gray-900 rounded-lg shadow-lg flex flex-col overflow-hidden shrink-0 text-gray-300 border border-gray-800">
                    <div class="p-3 border-b border-gray-700 bg-gray-800 text-sm font-bold flex justify-between items-center">
                        <span><i class="fa-solid fa-terminal mr-2 text-green-500"></i> 系统日志</span>
                        <button @click="fetchLogs" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-sync"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3 log-box bg-[#0d1117]">
                        <div v-for="(log, i) in taskLogs" :key="i" class="mb-1.5 border-b border-gray-800 pb-1 hover:text-white transition-colors">
                            <span class="text-green-600 mr-1">></span> {{ log }}
                        </div>
                        <div v-if="taskLogs.length === 0" class="text-center text-gray-600 mt-10 text-xs">暂无运行日志<br>点击"立即执行"开始任务</div>
                    </div>
                </div>
            </div>

            <!-- AI去重 Tab -->
            <div v-show="currentTab === 'dedupe'" class="h-full overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                        <h2 class="font-bold mb-4 text-gray-700 border-b pb-2">系统配置</h2>
                        <div class="space-y-4">
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">Gemini API Key</label>
                                <input type="password" v-model="form.apiKey" placeholder="输入 Key" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500 transition"></div>
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">Model Name</label>
                                <div class="flex gap-2">
                                    <input list="model-list" v-model="form.modelName" placeholder="gemini-1.5-flash" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500 transition">
                                    <datalist id="model-list"><option v-for="m in availableModels" :value="m">{{ m }}</option></datalist>
                                    <button @click="fetchModels" class="bg-gray-100 border border-gray-200 px-3 rounded hover:bg-gray-200 text-gray-600 transition tooltip" data-tip="刷新模型列表"><i class="fa-solid fa-sync"></i></button>
                                </div>
                            </div>
                            <div><label class="block text-xs text-gray-500 mb-1 font-bold uppercase">HTTP Proxy</label>
                                <input type="text" v-model="form.proxyUrl" placeholder="http://127.0.0.1:7890" class="w-full border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500 transition"></div>
                            <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 text-sm transition shadow-sm font-medium">保存配置</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h2 class="font-bold mb-4 text-gray-700 border-b pb-2">去重任务控制</h2>
                            <div class="bg-gray-50 p-4 rounded border border-gray-100 mb-4 min-h-[100px]">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span class="font-medium flex items-center gap-2"><i class="fa-solid fa-info-circle text-blue-500"></i> 状态: <span class="uppercase">{{ status.status }}</span></span>
                                    <span v-if="status.total > 0" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">{{ status.progress }} / {{ status.total }}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3 h-10 overflow-hidden">{{ status.message }}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden shadow-inner">
                                    <div class="progress-bar bg-blue-500 h-2 rounded-full" :style="{ width: progressPercent + '%' }"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button @click="startScanAll" :disabled="isBusy" class="flex-1 bg-white border border-blue-500 text-blue-600 py-2.5 rounded hover:bg-blue-50 disabled:opacity-50 transition shadow-sm font-medium">1. 全量扫描</button>
                            <button @click="startAnalyze" :disabled="isBusy || status.candidates_count === 0" class="flex-1 bg-purple-600 text-white py-2.5 rounded hover:bg-purple-700 disabled:opacity-50 transition shadow-sm font-medium flex items-center justify-center gap-2">
                                <i class="fa-solid fa-robot"></i> AI 智能分析
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="results.length > 0" class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                            {{ isAiResult ? 'AI 分析结果' : '疑似重复 (模糊匹配)' }} 
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2.5 py-1 rounded-full border border-indigo-200">{{ results.length }} 组</span>
                        </h3>
                        <button v-if="selectedFiles.length > 0" @click="deleteSelected" class="bg-red-600 text-white px-5 py-2 rounded text-sm hover:bg-red-700 shadow-md transition font-medium">
                            <i class="fa-solid fa-trash-can mr-1"></i> 删除选中 ({{ selectedFiles.length }})
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div v-for="(group, idx) in results" :key="idx" class="border rounded-lg p-4 bg-gray-50 hover:bg-white hover:shadow-md transition duration-200 border-gray-200">
                            <div class="text-xs font-bold text-yellow-800 bg-yellow-100 p-2 rounded mb-3 inline-block border border-yellow-200">
                                <i class="fa-solid fa-lightbulb text-yellow-600 mr-1"></i> {{ group.reason }}
                            </div>
                            <div class="space-y-2">
                                <div v-for="file in group.files" :key="file.path" @click="toggleSelect(file.path)"
                                    class="flex items-center gap-4 p-3 bg-white border border-gray-200 rounded-md cursor-pointer hover:border
